{% extends 'base.html' %} {% block header %}
<article id="canvas" class="my-2 py-2">
  <div class="result-card">
    <h3 class="result-title">나의 테니스 실력은?</h3>
    <div class="result-ntrp-character-wrap d-flex align-items-center">
      <img
        src="{{ url_for('static', filename=result['resultimage'])}}"
        alt="ntrp character"
        class="result-ntrp-character"
        id="result-ntrp-character"
      />
    </div>
    <div class="result-ntrp-grade">{{result['character_name']}}</div>
    <div class="result-ntrp-point">
      NTRP : <span class="result-ntrp-point-span">{{result['ntrp']}}</span>
    </div>
  </div>
</article>

{% endblock %} {% block content %}
<article id="result-content">
  <div class="flex-center">
    <div class="btn-custom" id="firstImgCopyBtn">
      결과화면 다운받기<i
        class="fa-regular fa-arrow-down-to-line color-white"
      ></i>
    </div>
  </div>
  <div class="result-character-description-wrap">
    <div class="result-character-description-content">
      {% for line in result['character_description'].split('\n') %} {{ line }}
      <br />
      {% endfor %}
    </div>
  </div>
  <div class="result-content-title">검사 결과</div>
  <div class="result-content-graph-wrap">
    <div class="result-content-graph-item">
      <div class="result-content-graph-item-title">
        포핸드 스트로크 NTRP :
        <span class="result-content-graph-item-score"
          >{{result['forehand']}}</span
        >
      </div>
      <div class="result-content-graph-item-content">
        {% for i in range(result['forehand']|int) %}
        <progress
          value="100"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% if result['forehand'] - (result['forehand']|int) > 0 %}
        <progress
          value="{{(result['forehand'] - (result['forehand'] // 1)) * 100}}"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% for i in range(6 - result['forehand']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% else %} {% for i in range(7 - result['forehand']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% endif %}
      </div>
    </div>
    <hr />

    <div class="result-content-graph-item">
      <div class="result-content-graph-item-title">
        백핸드 스트로크 NTRP :
        <span class="result-content-graph-item-score"
          >{{result['backhand']}}</span
        >
      </div>
      <div class="result-content-graph-item-content">
        {% for i in range(result['backhand']|int) %}
        <progress
          value="100"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% if result['backhand'] - (result['backhand']|int) > 0 %}
        <progress
          value="{{(result['backhand'] - (result['backhand'] // 1)) * 100}}"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% for i in range(6 - result['backhand']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% else %} {% for i in range(7 - result['backhand']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% endif %}
      </div>
    </div>
    <hr />
    <div class="result-content-graph-item">
      <div class="result-content-graph-item-title">
        서브&리턴 NTRP :
        <span class="result-content-graph-item-score"
          >{{result['servenreturn']}}</span
        >
      </div>
      <div class="result-content-graph-item-content">
        {% for i in range(result['servenreturn']|int) %}
        <progress
          value="100"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% if result['servenreturn'] - (result['servenreturn']|int)
        > 0 %}
        <progress
          value="{{(result['servenreturn'] - (result['servenreturn'] // 1)) * 100}}"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% for i in range(6 - result['servenreturn']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% else %} {% for i in range(7 -
        result['servenreturn']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% endif %}
      </div>
    </div>
    <hr />
    <div class="result-content-graph-item">
      <div class="result-content-graph-item-title">
        발리 NTRP :
        <span class="result-content-graph-item-score"
          >{{result['volley']}}</span
        >
      </div>
      <div class="result-content-graph-item-content">
        {% for i in range(result['volley']|int) %}
        <progress
          value="100"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% if result['volley'] - (result['volley']|int) > 0 %}
        <progress
          value="{{(result['volley'] - (result['volley'] // 1)) * 100}}"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% for i in range(6 - result['volley']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% else %} {% for i in range(7 - result['volley']|int) %}
        <progress
          value="0"
          min="0"
          max="100"
          class="result-content-graph-item-progress"
        ></progress>
        {% endfor %} {% endif %}
      </div>
    </div>
  </div>
  <div class="result-content-description-wrap">
    <div class="result-content-description-title">
      NTRP 등급 :
      <span class="result-content-graph-item-score">{{result['ntrp']}}</span>
    </div>
    <div class="result-content-description-content">
      {% for line in result['ntrp_content'].split('\n') %} {{ line }}
      <br />
      {% endfor %}
    </div>
  </div>
  <div class="result-content-share-wrap">
    <div class="result-content-share-text">
      <div class="result-content-share-text-up">
        내 친구의 ntrp 점수는 어떻게 될까?
      </div>
      <div class="result-content-share-text-down">NTRP+ 테스트 공유하기</div>
    </div>
    <div class="result-content-share-button-wrap">
      <div class="result-content-share-button btn-copy" id="imgCopyBtn">
        <img
          src="{{ url_for('static', filename='ic_download.svg')}}"
          alt="clipboard copy icon"
          class="btn-copy-icon"
        />
        <div class="tooltiptext">캐릭터 결과화면 다운받기</div>
      </div>
      <a id="kakaotalk-sharing-btn" href="javascript:;">
        <img
          src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_medium.png"
          alt="카카오톡 공유 보내기 버튼"
          class="result-content-share-button"
        />
      </a>
      <div class="result-content-share-button btn-url" id="urlShareBtn">
        URL
      </div>
    </div>
  </div>
  <div class="result-final-wrap">
    <a href="{{url_for('test')}}" class="result-final-btn-return"
      >테스트 다시하기</a
    >
    <div class="result-final-btn-copy" id="secondImgCopyBtn">
      캐릭터 결과화면 다운받기
    </div>
  </div>
  <div id="toast"></div>
</article>
<article id="download-image">
  <div>
    <img
      src="{{ url_for('static', filename=result['resultimage'])}}"
      alt="ntrp character"
      class="result-ntrp-character"
      id="result-ntrp-character"
    />
  </div>
</article>
<script
  src="https://t1.kakaocdn.net/kakao_js_sdk/2.0.0/kakao.min.js"
  integrity="sha384-PFHeU/4gvSH8kpvhrigAPfZGBDPs372JceJq3jAXce11bVA6rMvGWzvP4fMQuBGL"
  crossorigin="anonymous"
></script>
<script>
  Kakao.init(config.kakaoApiKey);
</script>
<script>
  Kakao.Share.createDefaultButton({
    container: "#kakaotalk-sharing-btn",
    objectType: "feed",
    content: {
      title: "나의 테니스 실력 점수는?",
      description: "간편하게 확인할 수 있는 나의 NTRP 등급",
      imageUrl: `${config.url}{{ url_for('static', filename=result['kakao_share_image'])}}`,
      link: {
        mobileWebUrl: "https://developers.kakao.com",
        webUrl: "https://developers.kakao.com",
      },
    },
    buttons: [
      {
        title: "친구 측정하기",
        link: {
          mobileWebUrl: `${config.url}/ntrp//test/{{playerId}}`,
          webUrl: `${config.url}/ntrp//test/{{playerId}}`,
        },
      },
      {
        title: "결과 보러 가기",
        link: {
          mobileWebUrl: `${config.url}/ntrp/result/{{testId}}`,
          webUrl: `${config.url}/ntrp/result/{{testId}}`,
        },
      },
    ],
  });
</script>
<script>
  const urlShareBtn = document.getElementById("urlShareBtn");
  const resultUrl = `${config.url}/ntrp/result/{{testId}}`;
  urlShareBtn.onclick = () => {
    window.navigator.clipboard.writeText(resultUrl).then(() => {
      toast("복사완료");
    });
  };
</script>
<script>
  let removeToast;

  function toast(string) {
    const toast = document.getElementById("toast");

    toast.classList.contains("reveal")
      ? (clearTimeout(removeToast),
        (removeToast = setTimeout(function () {
          document.getElementById("toast").classList.remove("reveal");
        }, 1000)))
      : (removeToast = setTimeout(function () {
          document.getElementById("toast").classList.remove("reveal");
        }, 1000));
    toast.classList.add("reveal"), (toast.innerText = string);
  }
</script>
<script src="{{ url_for('static', filename='html2canvas.min.js')}}"></script>
<script>
  async function saveAs(uri, filename) {
    var link = document.createElement("a");
    if (typeof link.download === "string") {
      // const response = await fetch(uri);
      // const blob = await response.blob();
      // await navigator.clipboard.write([
      //   new ClipboardItem({
      //     [blob.type]: blob,
      //   }),
      // ]);
      link.href = uri;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      window.open(uri);
    }
  }
  async function copyPicture() {
    try {
      $("#download-image").show();
      const screenshotTarget = document.querySelector("#download-image");
      html2canvas(screenshotTarget).then((canvas) => {
        const base64image = canvas.toDataURL("image/png");
        saveAs(base64image, "NTRP plus 테스트 결과.png");
        // window.location.href = base64image;
        // console.log(base64image);
        toast("이미지 다운로드 완료");
        $("#download-image").hide();
      });
    } catch (err) {
      console.error(err.name, err.message);
    }
  }

  document.getElementById("imgCopyBtn").onclick = () => {
    copyPicture();
  };
  document.getElementById("firstImgCopyBtn").onclick = () => {
    copyPicture();
  };
  document.getElementById("secondImgCopyBtn").onclick = () => {
    copyPicture();
  };
</script>
{% endblock %}
